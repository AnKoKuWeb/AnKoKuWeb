<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PeerCall — просто позвонить</title>
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --accent-ink:#06210f;
      --warn:#f59e0b; --danger:#ef4444; --ok:#34d399; --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:20px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    h1{font-size:26px;margin:0 0 8px}
    p.lead{margin:0 0 10px;color:var(--muted)}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    @media (max-width:860px){.col-4,.col-6,.col-8{grid-column:span 12}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--line);background:#0f172a;color:var(--ink);
         padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;min-height:48px;font-size:16px}
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .note{font-size:13px;color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:14px 0}
    textarea, input[type=text]{width:100%;padding:14px;border-radius:14px;background:#0a0f1a;color:var(--ink);border:1px solid var(--line);font-family:ui-monospace,Consolas,Menlo,monospace}
    textarea{min-height:128px;resize:vertical}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(34,197,94,.12);color:#b7f7cf;border:1px solid rgba(34,197,94,.25);padding:6px 10px;border-radius:999px}
    .k{display:inline-flex;align-items:center;gap:8px}
    .status{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
    .status .dot{width:10px;height:10px;border-radius:50%;background:#64748b}
    .status.ok .dot{background:var(--ok)} .status.warn .dot{background:var(--warn)} .status.bad .dot{background:var(--danger)}
    .meters{display:flex;gap:10px;margin-top:10px}
    .bar{flex:1;height:10px;background:#1f2937;border-radius:10px;overflow:hidden}
    .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16)}
    details{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.03)}
    summary{cursor:pointer}
    .float-tip{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>PeerCall — просто позвонить</h1>
    <p class="lead">Для семьи и друзей. Теперь с автоматическим соединением через PeerJS.</p>

    <div class="status" id="appStatus">
      <span class="dot"></span><b id="stateText">Готово к началу</b>
      <span class="badge" id="netHint">STUN: включён</span>
      <span class="badge" id="roleHint">Роль: не выбрана</span>
      <span class="badge" id="callHint">Звонок: нет</span>
      <span class="badge" id="peerId">ID: —</span>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <div class="col-4">
        <h3>Шаг 1 — Выберите роль</h3>
        <div class="row">
          <button class="btn" id="btnCaller">Я звоню</button>
          <button class="btn" id="btnCallee">Мне звонят</button>
          <label class="note"><input type="checkbox" id="ckStun" checked> Использовать STUN (рекомендуется)</label>
          <label class="note"><input type="checkbox" id="ckMom"> Режим «для мамы» (больше шрифты, меньше деталей)</label>
        </div>
        <div class="sep"></div>
        <h3>Шаг 2 — Микрофон</h3>
        <div class="row">
          <button class="btn primary" id="btnMic">Разрешить микрофон</button>
          <span class="badge" id="micBadge">Микрофон: неактивен</span>
        </div>
        <div class="meters">
          <div class="bar"><i id="lvLocal"></i></div>
          <div class="bar"><i id="lvRemote"></i></div>
        </div>
        <span class="float-tip">Левая полоса — вы, правая — собеседник.</span>
      </div>

      <div class="col-8">
        <h3>Шаг 3 — Подключение</h3>
        <div class="grid">
          <div class="col-12">
            <label class="note">ID собеседника:</label>
            <input type="text" id="peerIdInput" placeholder="Введите ID собеседника">
            <div class="row">
              <button class="btn primary" id="btnConnect">Соединиться</button>
              <button class="btn ghost" id="btnCopyId">Копировать мой ID</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <audio id="remoteAudio" autoplay playsinline></audio>
          <button class="btn danger" id="btnHang" disabled>Завершить звонок</button>
          <span class="badge" id="statRtt">RTT: —</span>
          <span class="badge" id="statBit">Битрейт: —</span>
          <span class="badge" id="statJit">Джиттер: —</span>
        </div>
      </div>
    </div>

    <div class="sep"></div>
    <details>
      <summary>Что важно знать</summary>
      <ul class="note">
        <li>Для соединения введите ID собеседника и нажмите "Соединиться".</li>
        <li>Если связь не установилась, попробуйте включить Wi‑Fi или другую сеть. Для «железобетона» нужен TURN‑ретранслятор.</li>
        <li>Для iOS лучше использовать установленную PWA (кнопка «Поделиться» → «На экран Домой»).</li>
      </ul>
    </details>
  </div>
</div>

<!-- Добавляем PeerJS библиотеку -->
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const ui = {
    appStatus: $('appStatus'), stateText: $('stateText'),
    netHint: $('netHint'), roleHint: $('roleHint'), callHint: $('callHint'), peerId: $('peerId'),
    btnCaller: $('btnCaller'), btnCallee: $('btnCallee'),
    ckStun: $('ckStun'), ckMom: $('ckMom'),
    btnMic: $('btnMic'), micBadge: $('micBadge'),
    lvLocal: $('lvLocal'), lvRemote: $('lvRemote'),
    peerIdInput: $('peerIdInput'),
    btnConnect: $('btnConnect'), btnCopyId: $('btnCopyId'),
    remoteAudio: $('remoteAudio'), btnHang: $('btnHang'),
    statRtt: $('statRtt'), statBit: $('statBit'), statJit: $('statJit')
  };

  const S = {
    role: null,
    useStun: true,
    mic: null,
    peer: null,
    conn: null,
    call: null,
    audioCtx: null,
    localAnalyser: null,
    remoteAnalyser: null,
    statsTimer: null,
    myPeerId: null
  };

  function setStatus(level, text){
    ui.appStatus.classList.remove('ok','warn','bad');
    ui.appStatus.classList.add(level);
    ui.stateText.textContent = text;
  }
  
  function setRole(r){
    S.role = r;
    ui.roleHint.textContent = 'Роль: ' + (r ? (r==='caller'?'я звоню':'мне звонят') : 'не выбрана');
  }
  
  ui.btnCaller.onclick = ()=>setRole('caller');
  ui.btnCallee.onclick = ()=>setRole('callee');

  ui.ckStun.onchange = ()=>{
    S.useStun = ui.ckStun.checked;
    ui.netHint.textContent = 'STUN: ' + (S.useStun?'включён':'выкл');
  };

  ui.ckMom.onchange = ()=>{
    document.body.style.fontSize = ui.ckMom.checked ? '18px' : '';
  };

  async function ensureMic(){
    if(S.mic) return;
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
      S.mic = s; 
      ui.micBadge.textContent = 'Микрофон: активен'; 
      ui.micBadge.style.color = '#b7f7cf';
      setupLocalLevelMeter(s);
    }catch(e){
      setStatus('bad','Микрофон недоступен'); 
      alert('Ошибка микрофона: ' + e.message);
    }
  }
  
  ui.btnMic.onclick = ensureMic;

  function initPeerJS() {
    if (S.peer) return;
    
    // Создаем новый Peer с случайным ID
    S.peer = new Peer({
      host: '0.peerjs.com',
      port: 443,
      secure: true,
      debug: 3,
      config: {
        iceServers: S.useStun ? [
          {urls:'stun:stun.l.google.com:19302'},
          {urls:'stun:stun1.l.google.com:19302'},
          {urls:'stun:stun2.l.google.com:19302'},
          {urls:'stun:stun3.l.google.com:19302'}
        ] : []
      }
    });
    
    S.peer.on('open', (id) => {
      S.myPeerId = id;
      ui.peerId.textContent = `ID: ${id.substring(0, 8)}...`;
      setStatus('ok','Готов к подключению');
    });
    
    S.peer.on('error', (err) => {
      console.error('PeerJS error:', err);
      setStatus('bad', `Ошибка: ${err.type}`);
    });
    
    // Обработка входящих вызовов
    S.peer.on('call', (incomingCall) => {
      if (S.role !== 'callee') return;
      
      setStatus('warn','Входящий звонок...');
      
      ensureMic().then(() => {
        incomingCall.answer(S.mic);
        S.call = incomingCall;
        
        incomingCall.on('stream', (remoteStream) => {
          ui.remoteAudio.srcObject = remoteStream;
          setupRemoteLevelMeter(remoteStream);
          setStatus('ok','На связи');
          ui.btnHang.disabled = false;
          startStats();
        });
        
        incomingCall.on('close', () => {
          hangUp();
        });
        
        incomingCall.on('error', (err) => {
          console.error('Call error:', err);
          setStatus('bad','Ошибка звонка');
          hangUp();
        });
      });
    });
  }

  async function connectToPeer() {
    if (!S.role) {
      alert('Выберите роль');
      return;
    }
    
    if (!S.peer) {
      initPeerJS();
      return;
    }
    
    const peerId = ui.peerIdInput.value.trim();
    if (!peerId) {
      alert('Введите ID собеседника');
      return;
    }
    
    if (S.role === 'caller') {
      await ensureMic();
      
      setStatus('warn','Соединяемся...');
      
      try {
        S.call = S.peer.call(peerId, S.mic);
        
        S.call.on('stream', (remoteStream) => {
          ui.remoteAudio.srcObject = remoteStream;
          setupRemoteLevelMeter(remoteStream);
          setStatus('ok','На связи');
          ui.btnHang.disabled = false;
          startStats();
        });
        
        S.call.on('close', () => {
          hangUp();
        });
        
        S.call.on('error', (err) => {
          console.error('Call error:', err);
          setStatus('bad','Ошибка звонка');
          hangUp();
        });
      } catch (err) {
        console.error('Call failed:', err);
        setStatus('bad','Не удалось соединиться');
      }
    }
  }
  
  ui.btnConnect.onclick = connectToPeer;
  
  ui.btnCopyId.onclick = async () => {
    if (!S.myPeerId) {
      alert('Сначала инициализируйте подключение');
      return;
    }
    
    try {
      await navigator.clipboard.writeText(S.myPeerId);
      ui.btnCopyId.textContent = 'Скопировано ✓';
      setTimeout(() => ui.btnCopyId.textContent = 'Копировать мой ID', 1200);
    } catch (e) {
      alert('Буфер обмена недоступен');
    }
  };

  function hangUp() {
    try {
      if (S.call) {
        S.call.close();
        S.call = null;
      }
      
      setStatus('warn','Звонок завершён');
      ui.btnHang.disabled = true;
      ui.callHint.textContent = 'Звонок: нет';
      stopStats();
      
      if (ui.remoteAudio.srcObject) {
        ui.remoteAudio.srcObject.getTracks().forEach(track => track.stop());
        ui.remoteAudio.srcObject = null;
      }
    } catch (e) {
      console.error('Error hanging up:', e);
    }
  }
  
  ui.btnHang.onclick = hangUp;

  function setupLocalLevelMeter(stream) {
    S.audioCtx = S.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const src = S.audioCtx.createMediaStreamSource(stream);
    const analyser = S.audioCtx.createAnalyser(); analyser.fftSize=256;
    src.connect(analyser); S.localAnalyser = analyser;
    loopLevels();
  }
  
  function setupRemoteLevelMeter(stream) {
    S.audioCtx = S.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const src = S.audioCtx.createMediaStreamSource(stream);
    const analyser = S.audioCtx.createAnalyser(); analyser.fftSize=256;
    src.connect(analyser); S.remoteAnalyser = analyser;
  }
  
  function loopLevels() {
    if(!S.localAnalyser && !S.remoteAnalyser) return;
    const draw = ()=>{
      if(S.localAnalyser){
        const data = new Uint8Array(S.localAnalyser.frequencyBinCount);
        S.localAnalyser.getByteFrequencyData(data);
        const v = Math.min(100, Math.round((data.reduce((a,b)=>a+b,0)/data.length)/2);
        ui.lvLocal.style.width = v + '%';
      }
      if(S.remoteAnalyser){
        const data = new Uint8Array(S.remoteAnalyser.frequencyBinCount);
        S.remoteAnalyser.getByteFrequencyData(data);
        const v = Math.min(100, Math.round((data.reduce((a,b)=>a+b,0)/data.length)/2);
        ui.lvRemote.style.width = v + '%';
      }
      requestAnimationFrame(draw);
    };
    requestAnimationFrame(draw);
  }

  function startStats() {
    stopStats();
    S.statsTimer = setInterval(async () => {
      if (!S.call) return;
      
      // В PeerJS нет прямого доступа к статистике соединения, как в WebRTC
      // Можно добавить более сложную логику отслеживания, если нужно
      ui.statRtt.textContent = 'RTT: —';
      ui.statJit.textContent = 'Джиттер: —';
      ui.statBit.textContent = 'Битрейт: —';
    }, 1200);
  }
  
  function stopStats() { 
    if (S.statsTimer) { 
      clearInterval(S.statsTimer); 
      S.statsTimer = null; 
    } 
  }

  // PWA
  if('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }

  // Инициализируем PeerJS при загрузке
  initPeerJS();
  setStatus('ok','Готово к началу');
})();
</script>
</body>
</html>