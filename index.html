<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PeerCall ‚Äî –∑–≤–æ–Ω–∫–∏ –∏ —ç–∫—Ä–∞–Ω</title>
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --accent-ink:#06210f;
      --warn:#f59e0b; --danger:#ef4444; --ok:#34d399; --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";}
    .wrap{max-width:1440px;margin:0 auto;padding:24px;height:100%;display:flex;flex-direction:column;position:relative;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:20px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.25);height:100%;display:flex;flex-direction:column;position:relative;z-index:10;}
    h1{font-size:26px;margin:0 0 8px}
    p.lead{margin:0 0 10px;color:var(--muted)}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr);flex-grow:1;}
    .col-4{grid-column:span 4;display:flex;flex-direction:column;gap:14px;}
    .col-6{grid-column:span 6} .col-8{grid-column:span 8;display:flex;flex-direction:column;}
    .col-12{grid-column:span 12}
    @media (max-width:1024px){.grid{flex-direction:column;}.col-4,.col-8{grid-column:span 12;}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--line);background:#0f172a;color:var(--ink);
         padding:14px 16px;border-radius:14px;font-weight:700;cursor:pointer;min-height:48px;font-size:16px}
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:var(--accent);color:var(--accent-ink);border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--danger);border-color:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line)}
    .note{font-size:13px;color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:14px 0}
    textarea, input[type=text]{width:100%;padding:14px;border-radius:14px;background:#0a0f1a;color:var(--ink);border:1px solid var(--line);font-family:ui-monospace,Consolas,Menlo,monospace}
    textarea{min-height:128px;resize:vertical}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(34,197,94,.12);color:#b7f7cf;border:1px solid rgba(34,197,94,.25);padding:6px 10px;border-radius:999px}
    .k{display:inline-flex;align-items:center;gap:8px}
    .status{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:rgba(255,255,255,.03)}
    .status .dot{width:10px;height:10px;border-radius:50%;background:#64748b}
    .status.ok .dot{background:var(--ok)} .status.warn .dot{background:var(--warn)} .status.bad .dot{background:var(--danger)}
    .meters{display:flex;gap:10px;margin-top:10px}
    .bar{flex:1;height:10px;background:#1f2937;border-radius:10px;overflow:hidden}
    .bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16)}
    details{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.03)}
    summary{cursor:pointer}
    .float-tip{font-size:12px;color:var(--muted)}
    .install{margin-left:auto}
    video{max-width:100%;width:100%;background:#000;border-radius:12px}
    audio{display:block}
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .screen-video-container {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #0b1220;
      z-index: 1; /* –ü–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –Ω–æ –Ω–∏–∂–µ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    }
    .screen-video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain; /* –ß—Ç–æ–±—ã –≤–∏–¥–µ–æ –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ –≤–∏–¥–Ω–æ —Ü–µ–ª–∏–∫–æ–º */
      border-radius: 0;
      z-index: 2;
    }
    .video-controls {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      background-color: rgba(15, 23, 42, 0.7);
      border-radius: 14px;
      padding: 10px 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 100;
    }
    .video-controls .badge {
      background: none;
      border: none;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>PeerCall ‚Äî –∑–≤–æ–Ω–∫–∏ –∏ —ç–∫—Ä–∞–Ω</h1>
    <p class="lead">–ó–≤–æ–Ω–∫–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞. –ë–µ–∑ –±—ç–∫–µ–Ω–¥–∞: –æ–±–º–µ–Ω ¬´–∫–æ–¥–∞–º–∏¬ª –≤—Ä—É—á–Ω—É—é. –†–∞–±–æ—Ç–∞–µ—Ç –≤ –º–æ–±–∏–ª—å–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ —á–µ—Ä–µ–∑ Electron.</p>

    <div class="status" id="appStatus">
      <span class="dot"></span><b id="stateText">–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É</b>
      <span class="badge" id="netHint">STUN: –≤–∫–ª—é—á—ë–Ω</span>
      <span class="badge" id="roleHint">–†–æ–ª—å: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</span>
      <span class="badge" id="callHint">–ó–≤–æ–Ω–æ–∫: –Ω–µ—Ç</span>
      <button class="btn ghost install" id="btnInstall" hidden>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <div class="col-12">
        <h3>–®–∞–≥ 1 ‚Äî –†–æ–ª—å</h3>
        <div class="row">
          <button class="btn" id="btnCaller">–Ø –∑–≤–æ–Ω—é</button>
          <button class="btn" id="btnCallee">–ú–Ω–µ –∑–≤–æ–Ω—è—Ç</button>
        </div>
        <label class="note"><input type="checkbox" id="ckStun" checked> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å STUN (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</label>
        <label class="note"><input type="checkbox" id="ckMom"> –†–µ–∂–∏–º ¬´–¥–ª—è –º–∞–º—ã¬ª (–∫—Ä—É–ø–Ω–µ–µ —à—Ä–∏—Ñ—Ç—ã)</label>

        <div class="sep"></div>
        <h3>–®–∞–≥ 2 ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
        <div class="row">
          <button class="btn primary" id="btnMic">–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
          <button class="btn" id="btnToggleMic" disabled>
            <span id="micToggleIcon">üéôÔ∏è</span><span id="micToggleText">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</span>
          </button>
          <button class="btn" id="btnShareScreen">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º</button>
          <button class="btn danger" id="btnStopShare" disabled>–°—Ç–æ–ø</button>
        </div>
        <div class="meters">
          <div class="bar"><i id="lvLocal"></i></div>
          <div class="bar"><i id="lvRemote"></i></div>
        </div>
        <span class="float-tip">–õ–µ–≤–∞—è –ø–æ–ª–æ—Å–∞ ‚Äî –≤—ã, –ø—Ä–∞–≤–∞—è ‚Äî —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫.</span>
      </div>

      <div class="col-12">
        <div class="sep"></div>
        <h3>–®–∞–≥ 3 ‚Äî –û–±–º–µ–Ω –∫–æ–¥–∞–º–∏ (–æ–¥–∏–Ω —Ä–∞–∑)</h3>
        <div class="grid">
          <div class="col-12">
            <label class="note">–í–∞—à –∫–æ–¥ (–ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É):</label>
            <textarea id="myCode" readonly placeholder="–ù–∞–∂–º–∏—Ç–µ ¬´–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥¬ª‚Ä¶"></textarea>
            <div class="row">
              <button class="btn primary" id="btnMake">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
              <button class="btn" id="btnCopy" disabled>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn ghost" id="btnShare" disabled>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è‚Ä¶</button>
            </div>
          </div>
          <div class="col-12">
            <label class="note">–ö–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</label>
            <textarea id="peerCode" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –∫–æ–¥"></textarea>
            <div class="row">
              <button class="btn" id="btnAccept">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
              <button class="btn ghost" id="btnPaste">–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="screen-video-container" hidden>
    <video id="remoteScreen" autoplay playsinline></video>
    <video id="localScreen" autoplay playsinline muted></video>
    <div class="video-controls">
      <audio id="remoteAudio" autoplay playsinline></audio>
      <button class="btn danger" id="btnHang" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <span class="badge" id="statRtt">RTT: ‚Äî</span>
      <span class="badge" id="statBit">–ë–∏—Ç—Ä–µ–π—Ç: ‚Äî</span>
      <span class="badge" id="statJit">–î–∂–∏—Ç—Ç–µ—Ä: ‚Äî</span>
    </div>
  </div>

</div>
<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const ui = {
    appStatus: $('appStatus'), stateText: $('stateText'),
    netHint: $('netHint'), roleHint: $('roleHint'), callHint: $('callHint'),
    btnCaller: $('btnCaller'), btnCallee: $('btnCallee'),
    ckStun: $('ckStun'), ckMom: $('ckMom'),
    btnMic: $('btnMic'), micBadge: $('micBadge'), btnToggleMic: $('btnToggleMic'), micToggleIcon: $('micToggleIcon'), micToggleText: $('micToggleText'),
    lvLocal: $('lvLocal'), lvRemote: $('lvRemote'),
    myCode: $('myCode'), peerCode: $('peerCode'),
    btnMake: $('btnMake'), btnCopy: $('btnCopy'), btnShare: $('btnShare'),
    btnAccept: $('btnAccept'), btnPaste: $('btnPaste'),
    remoteAudio: $('remoteAudio'), btnHang: $('btnHang'),
    statRtt: $('statRtt'), statBit: $('statBit'), statJit: $('statJit'),
    btnInstall: $('btnInstall'),
    btnShareScreen: $('btnShareScreen'), btnStopShare: $('btnStopShare'),
    localScreen: $('localScreen'), remoteScreen: $('remoteScreen'),
    screenVideoContainer: document.querySelector('.screen-video-container')
  };

  const S = {
    role: null,
    useStun: true,
    mic: null,
    pc: null,
    gathered: [],
    audioCtx: null,
    localAnalyser: null,
    remoteAnalyser: null,
    statsTimer: null,
    wakeLock: null,
    beforeInstallEvt: null,
    keepAliveTimer: null,
    screenStream: null,
    dc: null
  };

  // ----- UI helpers
  function setStatus(level, text){
    ui.appStatus.classList.remove('ok','warn','bad');
    ui.appStatus.classList.add(level);
    ui.stateText.textContent = text;
  }
  function setRole(r){
    S.role = r;
    ui.roleHint.textContent = '–†–æ–ª—å: ' + (r ? (r==='caller'?'—è –∑–≤–æ–Ω—é':'–º–Ω–µ –∑–≤–æ–Ω—è—Ç') : '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
  }
  ui.btnCaller.onclick = ()=>setRole('caller');
  ui.btnCallee.onclick = ()=>setRole('callee');

  ui.ckStun.onchange = ()=>{
    S.useStun = ui.ckStun.checked;
    ui.netHint.textContent = 'STUN: ' + (S.useStun?'–≤–∫–ª—é—á—ë–Ω':'–≤—ã–∫–ª');
  };
  ui.ckMom.onchange = ()=>{
    document.body.style.fontSize = ui.ckMom.checked ? '18px' : '';
  };

  // ----- MIC + AudioContext
  async function ensureMic(){
    if(S.mic) return;
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true}, video:false});
      S.mic = s;
      ui.btnMic.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω"
      ui.micBadge.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –∞–∫—Ç–∏–≤–µ–Ω'; ui.micBadge.style.color = '#b7f7cf';
      ui.btnToggleMic.disabled = false;
      setupLocalLevelMeter(s);
      kickAudioPipeline();
    }catch(e){
      setStatus('bad','–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); alert('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.message);
    }
  }
  ui.btnMic.onclick = ensureMic;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  ui.btnToggleMic.onclick = () => {
    if (!S.mic) return;
    const audioTrack = S.mic.getAudioTracks()[0];
    if (audioTrack) {
      audioTrack.enabled = !audioTrack.enabled;
      if (audioTrack.enabled) {
        ui.micToggleIcon.textContent = 'üéôÔ∏è';
        ui.micToggleText.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        ui.micBadge.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –∞–∫—Ç–∏–≤–µ–Ω';
      } else {
        ui.micToggleIcon.textContent = 'üîá';
        ui.micToggleText.textContent = '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        ui.micBadge.textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≤—ã–∫–ª—é—á–µ–Ω';
      }
    }
  };

  // ----- ICE servers
  function iceServers(){
    return S.useStun ? [
      {urls:'stun:stun.l.google.com:19302'},
      {urls:'stun:stun1.l.google.com:19302'},
      {urls:'stun:stun2.l.google.com:19302'},
      {urls:'stun:stun3.l.google.com:19302'}
    ] : [];
  }

  // ----- RTCPeerConnection
  function newPC(){
    if(S.pc){ try{ S.pc.close(); }catch{} }
    S.gathered = [];
    const pc = new RTCPeerConnection({iceServers: iceServers()});
    S.pc = pc;

    // –î–æ–±–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –∏–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    if(S.mic){ for(const t of S.mic.getTracks()) pc.addTrack(t, S.mic); }

    pc.ontrack = (ev)=>{
      if (ev.track.kind === 'video') {
        ui.remoteScreen.srcObject = ev.streams[0];
        ui.screenVideoContainer.hidden = false;
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–æ–≤
        ui.remoteScreen.hidden = false;
        ui.localScreen.hidden = true;
      }
      if (ev.track.kind === 'audio') {
        ui.remoteAudio.srcObject = ev.streams[0];
        ui.remoteAudio.play().catch(()=>{});
        setupRemoteLevelMeter(ev.streams[0]);
        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
        kickAudioPipeline();
      }
    };

    pc.onicecandidate = (ev)=>{ if(ev.candidate) S.gathered.push(ev.candidate.toJSON()); };

    pc.onconnectionstatechange = ()=>{
      const st = pc.connectionState;
      ui.callHint.textContent = '–ó–≤–æ–Ω–æ–∫: ' + st;

      if(st==='connecting'){ setStatus('warn','–°–æ–µ–¥–∏–Ω—è–µ–º‚Ä¶'); }
      if(st==='connected'){
        setStatus('ok','–ù–∞ —Å–≤—è–∑–∏');
        ui.btnHang.disabled=false;
        startStats();
        enableWakeLock();
        startKeepAlive();
      }
      if(st==='failed'){
        setStatus('bad','–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è');
        ui.btnHang.disabled=true;
        stopStats(); disableWakeLock(); stopKeepAlive();
      }
      if(st==='disconnected' || st==='closed'){
        setStatus('warn','–°–≤—è–∑—å –ø—Ä–µ—Ä–≤–∞–Ω–∞');
        ui.btnHang.disabled=true;
        stopStats(); disableWakeLock(); stopKeepAlive();
      }
    };
    return pc;
  }

  // ----- base64 packers (url-safe)
  function pack(obj){
    const s = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(s))).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
    return b64;
  }
  function unpack(b64url){
    const b64 = b64url.replaceAll('-','+').replaceAll('_','/');
    const pad = b64.length % 4 === 0 ? '' : '='.repeat(4 - (b64.length % 4));
    const json = decodeURIComponent(escape(atob(b64 + pad)));
    return JSON.parse(json);
  }

  function waitIceComplete(pc, timeoutMs=1200){
    return new Promise((resolve)=>{
      if(pc.iceGatheringState==='complete') return resolve();
      const t = setTimeout(resolve, timeoutMs);
      pc.onicegatheringstatechange = ()=>{
        if(pc.iceGatheringState==='complete'){ clearTimeout(t); resolve(); }
      };
    });
  }

  // ----- Make/Accept codes (c —É—á—ë—Ç–æ–º DC –¥–ª—è —Ä–µ–Ω–µ–≥–æ—Ü–∏–∞—Ü–∏–∏)
  async function makeCode(){
    if(!S.role){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å'); return; }
    await ensureMic();
    if(S.role==='caller'){
      const pc = newPC();
      // DataChannel –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ä–µ–Ω–µ–≥–æ—Ü–∏–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞)
      const dc = pc.createDataChannel('sig');
      dc.onmessage = (ev)=>handleSignal(ev.data);
      S.dc = dc;

      const offer = await pc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});
      await pc.setLocalDescription(offer);
      await waitIceComplete(pc);
      const payload = {v:3, role:'caller', sdp: pc.localDescription.toJSON(), ice: S.gathered, t: Date.now()};
      ui.myCode.value = pack(payload);
      ui.btnCopy.disabled = true; // –≤–∫–ª—é—á–∏–º –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞, —á—Ç–æ–±—ã –Ω–µ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ—Ç—É
      // –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã clipboard API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      setTimeout(()=>ui.btnCopy.disabled=false, 100);
      ui.btnShare.disabled = !navigator.share;
      setStatus('warn','–ñ–¥—ë–º –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞');
    }else{
      if(!ui.peerCode.value.trim()){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞'); return; }
      const ok = await acceptCode(true); if(!ok) return;

      // –ü–æ–ª—É—á–∏–º DataChannel –æ—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞
      S.pc.ondatachannel = (ev)=>{
        S.dc = ev.channel;
        S.dc.onmessage = (e)=>handleSignal(e.data);
      };

      const answer = await S.pc.createAnswer();
      await S.pc.setLocalDescription(answer);
      await waitIceComplete(S.pc);
      const payload = {v:3, role:'callee', sdp: S.pc.localDescription.toJSON(), ice: S.gathered, t: Date.now()};
      ui.myCode.value = pack(payload);
      ui.btnCopy.disabled = false;
      ui.btnShare.disabled = !navigator.share;
      setStatus('warn','–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä—É');
    }
  }
  ui.btnMake.onclick = makeCode;

  async function acceptCode(silent=false){
    const code = ui.peerCode.value.trim();
    if(!code){ if(!silent) alert('–ù–µ—Ç –∫–æ–¥–∞'); return false; }
    let obj;
    try{ obj = unpack(code); }
    catch(e){ if(!silent) alert('–§–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –Ω–µ–≤–µ—Ä–Ω—ã–π'); return false; }
    if(!obj || !obj.sdp){ if(!silent) alert('–í –∫–æ–¥–µ –Ω–µ—Ç SDP'); return false; }
    await ensureMic();
    const pc = S.pc ?? newPC();
    try{ await pc.setRemoteDescription(obj.sdp); }
    catch(e){ if(!silent) alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ'); return false; }
    if(Array.isArray(obj.ice)){ for(const c of obj.ice){ try{ await pc.addIceCandidate(c); }catch{} } }
    if(!silent) setStatus('warn','–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç. –°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –∫–æ–¥.');
    return true;
  }
  ui.btnAccept.onclick = ()=>acceptCode(false);

  // ----- Clipboard + Share
  ui.btnCopy.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(ui.myCode.value); ui.btnCopy.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì'; setTimeout(()=>ui.btnCopy.textContent='–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å',1200); }
    catch(e){ alert('–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
  };
  ui.btnShare.onclick = async ()=>{
    try{ await navigator.share({title:'–ö–æ–¥ PeerCall', text: ui.myCode.value}); }catch{}
  };
  ui.btnPaste.onclick = async ()=>{
    try{ const t = await navigator.clipboard.readText(); if(t) ui.peerCode.value = t; }catch{ alert('–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); }
  };

  // ----- Hangup
  ui.btnHang.onclick = ()=>{
    try{
      if(S.pc){
        S.pc.getSenders().forEach(s=>{ try{s.track && s.track.stop()}catch{} });
        S.pc.close();
      }
      S.pc=null;
      stopScreenShare();
      stopStats(); disableWakeLock(); stopKeepAlive();
      setStatus('warn','–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
      ui.btnHang.disabled=true; ui.callHint.textContent='–ó–≤–æ–Ω–æ–∫: –Ω–µ—Ç';
      if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'none';
      ui.screenVideoContainer.hidden = true;
    }catch{}
  };

  // ----- Level meters
  function setupLocalLevelMeter(stream){
    S.audioCtx = S.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const src = S.audioCtx.createMediaStreamSource(stream);
    const analyser = S.audioCtx.createAnalyser(); analyser.fftSize=256;
    src.connect(analyser); S.localAnalyser = analyser;
    loopLevels();
  }
  function setupRemoteLevelMeter(stream){
    S.audioCtx = S.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const src = S.audioCtx.createMediaStreamSource(stream);
    const analyser = S.audioCtx.createAnalyser(); analyser.fftSize=256;
    src.connect(analyser); S.remoteAnalyser = analyser;
  }
  function loopLevels(){
    if(!S.localAnalyser && !S.remoteAnalyser) return;
    const draw = ()=>{
      if(S.localAnalyser){
        const data = new Uint8Array(S.localAnalyser.frequencyBinCount);
        S.localAnalyser.getByteFrequencyData(data);
        const v = Math.min(100, Math.round((data.reduce((a,b)=>a+b,0)/data.length)/2));
        ui.lvLocal.style.width = v + '%';
      }
      if(S.remoteAnalyser){
        const data = new Uint8Array(S.remoteAnalyser.frequencyBinCount);
        S.remoteAnalyser.getByteFrequencyData(data);
        const v = Math.min(100, Math.round((data.reduce((a,b)=>a+b,0)/data.length)/2));
        ui.lvRemote.style.width = v + '%';
      }
      requestAnimationFrame(draw);
    };
    requestAnimationFrame(draw);
  }

  // ----- Stats
  function startStats(){
    stopStats();
    S.statsTimer = setInterval(async ()=>{
      if(!S.pc) return;
      try{
        const stats = await S.pc.getStats();
        let rtt='‚Äî', br='‚Äî', jit='‚Äî';
        stats.forEach(report=>{
          if(report.type==='remote-inbound-rtp' && report.kind==='audio'){
            if(report.roundTripTime) rtt = (report.roundTripTime*1000).toFixed(0)+' –º—Å';
            if(report.jitter) jit = (report.jitter*1000).toFixed(0)+' –º—Å';
          }
          if(report.type==='candidate-pair' && report.state==='succeeded'){
            if(report.availableOutgoingBitrate) br = (report.availableOutgoingBitrate/1000).toFixed(0)+' –∫–±–∏—Ç/—Å';
          }
        });
        ui.statRtt.textContent = 'RTT: ' + rtt;
        ui.statJit.textContent = '–î–∂–∏—Ç—Ç–µ—Ä: ' + jit;
        ui.statBit.textContent = '–ë–∏—Ç—Ä–µ–π—Ç: ' + br;
      }catch{}
    }, 1200);
  }
  function stopStats(){ if(S.statsTimer){ clearInterval(S.statsTimer); S.statsTimer=null; } }

  // ====== –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –≠–ö–†–ê–ù–ê (–≥–∏–±—Ä–∏–¥ Electron + Browser)
  async function startScreenShare() {
    if (!S.pc) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'); return; }
    if (S.screenStream) { alert('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞'); return; }
    
    ui.btnShareScreen.disabled = true;

    try {
      let stream;
      if (window.electronShare?.pickScreenWithAudio) {
        const sourceId = await window.electronShare.pickScreenWithAudio();
        stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: sourceId
            }
          },
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: sourceId,
              minWidth: 1280,
              minHeight: 720,
              maxWidth: 1920,
              maxHeight: 1080
            }
          }
        });
      } else {
        stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
      }

      S.screenStream = stream;
      ui.localScreen.srcObject = stream;
      ui.screenVideoContainer.hidden = false;
      ui.remoteScreen.hidden = true;
      ui.localScreen.hidden = false;
      
      ui.btnStopShare.disabled = false;
      
      stream.getTracks().forEach(t => S.pc && S.pc.addTrack(t, stream));
      renegotiate();

      stream.getTracks().forEach(t => t.onended = stopScreenShare);

    } catch (e) {
      alert('–≠–∫—Ä–∞–Ω: ' + e.message);
      ui.btnShareScreen.disabled = false;
    }
  }

  function stopScreenShare(){
    if(!S.screenStream) return;
    try{ S.screenStream.getTracks().forEach(t=>t.stop()); }catch{}
    S.screenStream = null;
    ui.localScreen.srcObject = null; 
    ui.localScreen.hidden = true;
    ui.btnStopShare.disabled = true;
    ui.btnShareScreen.disabled = false;
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–∞–∫–∂–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    if (!ui.remoteScreen.srcObject) {
      ui.screenVideoContainer.hidden = true;
    }
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –∑–∞–≥–ª—É—à–∫–∞
    const screenSender = S.pc.getSenders().find(sender => sender.track.kind === 'video' && sender.track !== S.mic.getAudioTracks()[0]);
    if (screenSender) {
        S.pc.removeTrack(screenSender);
        renegotiate();
    }
  }

  ui.btnShareScreen.onclick = startScreenShare;
  ui.btnStopShare.onclick = stopScreenShare;

  async function renegotiate(){
    if(!S.pc || !S.dc) return;
    const offer = await S.pc.createOffer();
    await S.pc.setLocalDescription(offer);
    await waitIceComplete(S.pc);
    const payload = {type:'offer', sdp:S.pc.localDescription.toJSON(), ice:S.gathered};
    S.dc.send(JSON.stringify(payload));
  }
  async function handleSignal(msg){
    const data = JSON.parse(msg);
    if(data.type==='offer'){
      await S.pc.setRemoteDescription(data.sdp);
      if(data.ice){ for(const c of data.ice){ try{ await S.pc.addIceCandidate(c); }catch{} } }
      const answer = await S.pc.createAnswer();
      await S.pc.setLocalDescription(answer);
      await waitIceComplete(S.pc);
      S.dc.send(JSON.stringify({type:'answer', sdp:S.pc.localDescription.toJSON(), ice:S.gathered}));
    }
    if(data.type==='answer'){
      await S.pc.setRemoteDescription(data.sdp);
      if(data.ice){ for(const c of data.ice){ try{ await S.pc.addIceCandidate(c); }catch{} } }
    }
  }

  // ====== ANDROID / BACKGROUND TRICKS ======
  async function enableWakeLock(){
    try{
      if ('wakeLock' in navigator) {
        S.wakeLock = await navigator.wakeLock.request('screen');
        S.wakeLock.addEventListener('release', ()=>console.log('WakeLock released'));
      }
    }catch(e){ console.warn('WakeLock error', e); }
  }
  async function disableWakeLock(){
    try{
      if (S.wakeLock){ await S.wakeLock.release(); S.wakeLock = null; }
    }catch{}
  }
  function startKeepAlive(){
    stopKeepAlive();
    S.keepAliveTimer = setInterval(()=>{
      kickAudioPipeline();
      if (navigator.serviceWorker?.controller) {
        navigator.serviceWorker.controller.postMessage({type:'ping', t: Date.now()});
      }
    }, 30000);
  }
  function stopKeepAlive(){
    if(S.keepAliveTimer){ clearInterval(S.keepAliveTimer); S.keepAliveTimer=null; }
  }
  function kickAudioPipeline(){
    try{ ui.remoteAudio.muted = false; ui.remoteAudio.play().catch(()=>{}); }catch{}
    if (S.audioCtx && S.audioCtx.state !== 'running') {
      S.audioCtx.resume().catch(()=>{});
    }
  }
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible') kickAudioPipeline();
  });
  window.addEventListener('focus', kickAudioPipeline);
  window.addEventListener('pageshow', kickAudioPipeline);

  // ====== PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ======
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    S.beforeInstallEvt = e;
    ui.btnInstall.hidden = false;
  });
  ui.btnInstall.onclick = async ()=>{
    if(!S.beforeInstallEvt) return;
    ui.btnInstall.disabled = true;
    await S.beforeInstallEvt.prompt();
    S.beforeInstallEvt = null;
    setTimeout(()=>{ ui.btnInstall.hidden = true; ui.btnInstall.disabled = false; }, 500);
  };

  // ====== Service Worker ======
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('./sw.js')
        .then(()=>console.log('SW registered'))
        .catch((e)=>console.warn('SW failed', e));
    });
    navigator.serviceWorker.addEventListener('message', (ev)=>{
      if (ev.data && ev.data.type === 'NEW_VERSION') {
        const ok = confirm('–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–µ–π—á–∞—Å?');
        if (ok) location.reload();
      }
    });
  }

  // ----- Init
  setStatus('ok','–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É');
})();
</script>
</body>
</html>