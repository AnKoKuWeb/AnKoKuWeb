<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PeerCall — звонки и экран</title>
  <meta name="theme-color" content="#0b1220">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --accent-ink:#06210f;
      --warn:#f59e0b; --danger:#ef4444; --ok:#34d399; --line:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid var(--line);border-radius:20px;padding:18px}
    h1{font-size:26px;margin:0 0 8px}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .col-4{grid-column:span 4} .col-8{grid-column:span 8}
    @media(max-width:860px){.col-4,.col-8{grid-column:span 12}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
         border:1px solid var(--line);background:#1f2937;color:var(--ink);
         padding:12px 16px;border-radius:14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink);border:none}
    .btn.danger{background:var(--danger);border:none}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    textarea{width:100%;padding:12px;border-radius:14px;background:#0a0f1a;color:var(--ink);
             border:1px solid var(--line);font-family:monospace;min-height:80px}
    video{max-width:100%;width:100%;background:#000;border-radius:12px}
    audio{display:block;margin-top:10px}
    .badge{font-size:12px;color:var(--muted)}
    .sep{height:1px;background:var(--line);margin:14px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>PeerCall</h1>
    <p>Звонки и демонстрация экрана (авто через DataChannel, без второго кода).</p>

    <div class="grid">
      <div class="col-4">
        <h3>Шаг 1 — Роль</h3>
        <div class="row">
          <button class="btn" id="btnCaller">Я звоню</button>
          <button class="btn" id="btnCallee">Мне звонят</button>
        </div>

        <div class="sep"></div>
        <h3>Шаг 2 — Микрофон</h3>
        <div class="row">
          <button class="btn primary" id="btnMic">Разрешить</button>
          <span class="badge" id="micBadge">выкл</span>
        </div>

        <div class="sep"></div>
        <h3>Шаг 3 — Экран</h3>
        <div class="row">
          <button class="btn" id="btnShareScreen">Поделиться экраном</button>
          <button class="btn danger" id="btnStopShare" disabled>Стоп</button>
        </div>
        <video id="localScreen" autoplay playsinline muted hidden></video>
      </div>

      <div class="col-8">
        <h3>Обмен кодами (только один раз!)</h3>
        <textarea id="myCode" readonly></textarea>
        <div class="row">
          <button class="btn primary" id="btnMake">Сформировать код</button>
          <button class="btn" id="btnCopy" disabled>Копировать</button>
        </div>
        <textarea id="peerCode" placeholder="Вставьте код собеседника"></textarea>
        <button class="btn" id="btnAccept">Принять код</button>

        <div class="sep"></div>
        <video id="remoteScreen" autoplay playsinline></video>
        <audio id="remoteAudio" autoplay playsinline></audio>
        <div class="row">
          <button class="btn danger" id="btnHang" disabled>Завершить звонок</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const ui={
  btnCaller:$("btnCaller"), btnCallee:$("btnCallee"),
  btnMic:$("btnMic"), micBadge:$("micBadge"),
  btnMake:$("btnMake"), btnCopy:$("btnCopy"),
  btnAccept:$("btnAccept"), myCode:$("myCode"), peerCode:$("peerCode"),
  remoteAudio:$("remoteAudio"), remoteScreen:$("remoteScreen"),
  btnHang:$("btnHang"),
  btnShareScreen:$("btnShareScreen"), btnStopShare:$("btnStopShare"),
  localScreen:$("localScreen")
};
const S={role:null,mic:null,pc:null,gathered:[],screenStream:null,dc:null};

ui.btnCaller.onclick=()=>S.role="caller";
ui.btnCallee.onclick=()=>S.role="callee";

async function ensureMic(){
  if(S.mic) return;
  try{
    S.mic=await navigator.mediaDevices.getUserMedia({audio:true});
    ui.micBadge.textContent="вкл";
  }catch(e){alert("Микрофон: "+e.message);}
}
ui.btnMic.onclick=ensureMic;

function pack(o){return btoa(JSON.stringify(o)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
function unpack(s){return JSON.parse(atob(s.replace(/-/g,'+').replace(/_/g,'/')));}
function waitIceComplete(pc,ms=1000){return new Promise(r=>{
  if(pc.iceGatheringState==="complete") return r();
  const t=setTimeout(r,ms);
  pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==="complete"){clearTimeout(t);r();}};
});}

function newPC(){
  if(S.pc) try{S.pc.close();}catch{}
  S.gathered=[];
  const pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  S.pc=pc;
  if(S.mic){for(const t of S.mic.getTracks()) pc.addTrack(t,S.mic);}
  pc.ontrack=ev=>{
    if(ev.track.kind==="video") ui.remoteScreen.srcObject=ev.streams[0];
    if(ev.track.kind==="audio") ui.remoteAudio.srcObject=ev.streams[0];
  };
  pc.onicecandidate=ev=>{if(ev.candidate) S.gathered.push(ev.candidate.toJSON());};
  pc.onconnectionstatechange=()=>{if(pc.connectionState==="connected") ui.btnHang.disabled=false;};
  return pc;
}

ui.btnMake.onclick=async()=>{
  if(!S.role){alert("Выберите роль");return;}
  await ensureMic();
  if(S.role==="caller"){
    const pc=newPC();
    // создаём DataChannel для сигнализации
    const dc=pc.createDataChannel("sig");
    dc.onmessage=ev=>handleSignal(ev.data);
    S.dc=dc;

    const offer=await pc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});
    await pc.setLocalDescription(offer);
    await waitIceComplete(pc);
    ui.myCode.value=pack({role:"caller",sdp:pc.localDescription.toJSON(),ice:S.gathered});
    ui.btnCopy.disabled=false;
  }else{
    if(!ui.peerCode.value.trim()){alert("Введите код собеседника");return;}
    await acceptCode();
    S.pc.ondatachannel=ev=>{
      S.dc=ev.channel;
      S.dc.onmessage=e=>handleSignal(e.data);
    };
    const answer=await S.pc.createAnswer();
    await S.pc.setLocalDescription(answer);
    await waitIceComplete(S.pc);
    ui.myCode.value=pack({role:"callee",sdp:S.pc.localDescription.toJSON(),ice:S.gathered});
    ui.btnCopy.disabled=false;
  }
};
ui.btnCopy.onclick=()=>navigator.clipboard.writeText(ui.myCode.value);

async function acceptCode(){
  let obj;try{obj=unpack(ui.peerCode.value.trim());}catch{alert("Неверный код");return;}
  await ensureMic();
  const pc=S.pc??newPC();
  await pc.setRemoteDescription(obj.sdp);
  if(obj.ice){for(const c of obj.ice){try{await pc.addIceCandidate(c);}catch{}}}
}
ui.btnAccept.onclick=acceptCode;

ui.btnHang.onclick=()=>{if(S.pc){S.pc.close();S.pc=null;}stopScreenShare();ui.btnHang.disabled=true;};

ui.btnShareScreen.onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    S.screenStream=stream;
    ui.localScreen.srcObject=stream;ui.localScreen.hidden=false;ui.btnStopShare.disabled=false;

    stream.getTracks().forEach(t=>S.pc.addTrack(t,stream));

    // renegotiation автоматически по DataChannel
    renegotiate();

    stream.getTracks().forEach(t=>t.onended=stopScreenShare);
  }catch(e){alert("Экран: "+e.message);}
};
function stopScreenShare(){
  if(!S.screenStream)return;
  S.screenStream.getTracks().forEach(t=>t.stop());
  S.screenStream=null;
  ui.localScreen.srcObject=null;ui.localScreen.hidden=true;ui.btnStopShare.disabled=true;
}
ui.btnStopShare.onclick=stopScreenShare;

// ==== Авто-ренеготиация через DataChannel ====
async function renegotiate(){
  if(!S.pc||!S.dc) return;
  const offer=await S.pc.createOffer();
  await S.pc.setLocalDescription(offer);
  await waitIceComplete(S.pc);
  const payload={type:"offer",sdp:S.pc.localDescription.toJSON(),ice:S.gathered};
  S.dc.send(JSON.stringify(payload));
}
async function handleSignal(msg){
  const data=JSON.parse(msg);
  if(data.type==="offer"){
    await S.pc.setRemoteDescription(data.sdp);
    if(data.ice){for(const c of data.ice){try{await S.pc.addIceCandidate(c);}catch{}}}
    const answer=await S.pc.createAnswer();
    await S.pc.setLocalDescription(answer);
    await waitIceComplete(S.pc);
    S.dc.send(JSON.stringify({type:"answer",sdp:S.pc.localDescription.toJSON(),ice:S.gathered}));
  }
  if(data.type==="answer"){
    await S.pc.setRemoteDescription(data.sdp);
    if(data.ice){for(const c of data.ice){try{await S.pc.addIceCandidate(c);}catch{}}}
  }
}
</script>
</body>
</html>
