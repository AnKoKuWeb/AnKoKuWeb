<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>PeerCall — демонстрация экрана</title>
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root {
      --bg: #0b1220; --panel: #0f172a; --ink: #e5e7eb; --muted: #9ca3af; 
      --accent: #22c55e; --accent-ink: #06210f; --warn: #f59e0b; 
      --danger: #ef4444; --ok: #34d399; --line: rgba(255,255,255,.08);
      --screen: #8b5cf6; --screen-light: #f5f3ff;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans";
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line); border-radius: 20px; padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25)
    }
    h1 { font-size: 26px; margin: 0 0 8px }
    p.lead { margin: 0 0 10px; color: var(--muted) }
    .grid { display: grid; gap: 14px; grid-template-columns: repeat(12, 1fr) }
    .col-4 { grid-column: span 4 } .col-6 { grid-column: span 6 } 
    .col-8 { grid-column: span 8 } .col-12 { grid-column: span 12 }
    @media (max-width: 860px) { .col-4, .col-6, .col-8 { grid-column: span 12 } }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      border: 1px solid var(--line); background: #0f172a; color: var(--ink);
      padding: 14px 16px; border-radius: 14px; font-weight: 700; cursor: pointer;
      min-height: 48px; font-size: 16px
    }
    .btn:hover { border-color: rgba(255,255,255,.25) }
    .btn.primary { background: var(--accent); color: var(--accent-ink); border-color: transparent }
    .btn.screen { background: var(--screen); color: var(--screen-light); border-color: transparent }
    .btn.ghost { background: transparent }
    .btn.danger { background: var(--danger); border-color: transparent }
    .btn:disabled { opacity: .55; cursor: not-allowed }
    .row { display: flex; flex-wrap: wrap; gap: 10px }
    .badge {
      display: inline-flex; align-items: center; gap: 6px; font-size: 12px;
      color: var(--muted); padding: 4px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06); border: 1px solid var(--line)
    }
    .note { font-size: 13px; color: var(--muted) }
    .sep { height: 1px; background: var(--line); margin: 14px 0 }
    textarea, input[type=text] {
      width: 100%; padding: 14px; border-radius: 14px; background: #0a0f1a;
      color: var(--ink); border: 1px solid var(--line); font-family: ui-monospace, Consolas, Menlo, monospace
    }
    textarea { min-height: 128px; resize: vertical }
    .status {
      display: flex; align-items: center; gap: 8px; padding: 10px 12px;
      border: 1px dashed var(--line); border-radius: 12px; background: rgba(255,255,255,.03)
    }
    .status .dot { width: 10px; height: 10px; border-radius: 50%; background: #64748b }
    .status.ok .dot { background: var(--ok) } 
    .status.warn .dot { background: var(--warn) } 
    .status.bad .dot { background: var(--danger) }
    .status.screen .dot { background: var(--screen) }
    
    /* Стили для демонстрации экрана */
    #screenPreview {
      max-width: 100%; border-radius: 12px; border: 1px solid var(--line);
      margin-top: 10px; display: none; background: #000
    }
    .remote-media-container {
      position: relative; margin-top: 16px; border-radius: 12px;
      overflow: hidden; background: #000; border: 1px solid var(--line)
    }
    #remoteScreen {
      width: 100%; display: block; background: #000
    }
    .media-controls {
      position: absolute; bottom: 8px; left: 0; right: 0;
      display: flex; justify-content: center; gap: 8px
    }
    .media-controls .btn {
      padding: 8px 12px; font-size: 12px; opacity: 0.8;
      background: rgba(0,0,0,0.7); color: white
    }
    .media-label {
      position: absolute; top: 8px; left: 8px;
      background: rgba(0,0,0,0.7); color: white;
      padding: 4px 8px; border-radius: 4px; font-size: 12px
    }
    .fullscreen { background: black; z-index: 9999; position: fixed !important;
      top: 0 !important; left: 0 !important; width: 100% !important;
      height: 100% !important; margin: 0 !important; border-radius: 0 !important }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>PeerCall — демонстрация экрана</h1>
    <p class="lead">Демонстрируйте экран со звуком. Без регистраций и бэкенда.</p>

    <div class="status" id="appStatus">
      <span class="dot"></span><b id="stateText">Готово к началу</b>
      <span class="badge" id="netHint">STUN: включён</span>
      <span class="badge" id="roleHint">Роль: не выбрана</span>
      <span class="badge" id="callHint">Звонок: нет</span>
      <button class="btn ghost install" id="btnInstall" hidden>Установить приложение</button>
    </div>

    <div class="sep"></div>

    <div class="grid">
      <div class="col-4">
        <h3>Шаг 1 — Выберите роль</h3>
        <div class="row">
          <button class="btn" id="btnCaller">Я звоню</button>
          <button class="btn" id="btnCallee">Мне звонят</button>
          <label class="note"><input type="checkbox" id="ckStun" checked> Использовать STUN</label>
        </div>
        <div class="sep"></div>
        <h3>Шаг 2 — Медиа</h3>
        <div class="row">
          <button class="btn primary" id="btnMic">Разрешить микрофон</button>
          <button class="btn screen" id="btnScreen" style="display:none">Демонстрация экрана</button>
          <span class="badge" id="micBadge">Микрофон: неактивен</span>
          <span class="badge" id="screenBadge" style="display:none">Экран: неактивен</span>
        </div>
        <video id="screenPreview" muted playsinline></video>
      </div>

      <div class="col-8">
        <h3>Шаг 3 — Обмен кодами</h3>
        <div class="grid">
          <div class="col-12">
            <label class="note">Ваш код (передайте собеседнику):</label>
            <textarea id="myCode" readonly placeholder="Нажмите «Сформировать код»…"></textarea>
            <div class="row">
              <button class="btn primary" id="btnMake">Сформировать код</button>
              <button class="btn" id="btnCopy" disabled>Копировать</button>
              <button class="btn ghost" id="btnShare" disabled>Поделиться…</button>
            </div>
          </div>
          <div class="col-12">
            <label class="note">Код собеседника:</label>
            <textarea id="peerCode" placeholder="Вставьте сюда код"></textarea>
            <div class="row">
              <button class="btn" id="btnAccept">Подтвердить код</button>
              <button class="btn ghost" id="btnPaste">Вставить из буфера</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <audio id="remoteAudio" autoplay playsinline></audio>
          <!-- Контейнер для удаленного экрана -->
          <div class="col-12 remote-media-container" id="remoteScreenContainer" style="display:none">
            <span class="media-label">Экран собеседника</span>
            <video id="remoteScreen" autoplay playsinline></video>
            <div class="media-controls">
              <button class="btn ghost" id="btnFullscreen">Полный экран</button>
              <button class="btn ghost" id="btnMuteAudio" style="display:none">Выключить звук</button>
            </div>
          </div>
          <button class="btn danger" id="btnHang" disabled>Завершить звонок</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>
    <details>
      <summary>Как это работает</summary>
      <ul class="note">
        <li>Демонстрация экрана работает в Chrome, Edge и Firefox (со звуком в Chrome/Edge)</li>
        <li>Для полноэкранного режима нажмите кнопку "Полный экран" под трансляцией</li>
        <li>Звук передается автоматически при выборе соответствующей опции в браузере</li>
        <li>Если связь не установилась, попробуйте выключить и включить STUN</li>
      </ul>
    </details>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const ui = {
    appStatus: $('appStatus'), stateText: $('stateText'),
    netHint: $('netHint'), roleHint: $('roleHint'), callHint: $('callHint'),
    btnCaller: $('btnCaller'), btnCallee: $('btnCallee'),
    ckStun: $('ckStun'),
    btnMic: $('btnMic'), btnScreen: $('btnScreen'),
    micBadge: $('micBadge'), screenBadge: $('screenBadge'),
    screenPreview: $('screenPreview'),
    myCode: $('myCode'), peerCode: $('peerCode'),
    btnMake: $('btnMake'), btnCopy: $('btnCopy'), btnShare: $('btnShare'),
    btnAccept: $('btnAccept'), btnPaste: $('btnPaste'),
    remoteAudio: $('remoteAudio'), remoteScreen: $('remoteScreen'),
    remoteScreenContainer: $('remoteScreenContainer'),
    btnFullscreen: $('btnFullscreen'), btnMuteAudio: $('btnMuteAudio'),
    btnHang: $('btnHang'), btnInstall: $('btnInstall')
  };

  const S = {
    role: null,
    useStun: true,
    mic: null,
    screen: null,
    isSharingScreen: false,
    pc: null,
    gathered: [],
    audioCtx: null,
    statsTimer: null,
    wakeLock: null,
    beforeInstallEvt: null,
    keepAliveTimer: null,
    isFullscreen: false,
    isRemoteAudioMuted: false
  };

  // ----- UI helpers
  function setStatus(level, text) {
    ui.appStatus.classList.remove('ok', 'warn', 'bad', 'screen');
    if (level) ui.appStatus.classList.add(level);
    ui.stateText.textContent = text;
  }

  function setRole(r) {
    S.role = r;
    ui.roleHint.textContent = 'Роль: ' + (r ? (r === 'caller' ? 'я звоню' : 'мне звонят') : 'не выбрана');
  }

  ui.btnCaller.onclick = () => setRole('caller');
  ui.btnCallee.onclick = () => setRole('callee');

  ui.ckStun.onchange = () => {
    S.useStun = ui.ckStun.checked;
    ui.netHint.textContent = 'STUN: ' + (S.useStun ? 'включён' : 'выкл');
  };

  // ----- MIC + AudioContext
  async function ensureMic() {
    if (S.mic) return;
    try {
      const s = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true },
        video: false
      });
      S.mic = s;
      ui.micBadge.textContent = 'Микрофон: активен';
      ui.micBadge.style.color = '#b7f7cf';
    } catch (e) {
      setStatus('bad', 'Микрофон недоступен');
      alert('Ошибка микрофона: ' + e.message);
    }
  }
  ui.btnMic.onclick = ensureMic;

  // ----- SCREEN SHARE
  async function toggleScreenShare() {
    if (S.isSharingScreen) {
      // Stop sharing
      try {
        S.screen.getTracks().forEach(track => track.stop());
        ui.screenPreview.srcObject = null;
        ui.screenPreview.style.display = 'none';
      } catch (e) { }
      
      S.screen = null;
      S.isSharingScreen = false;
      ui.btnScreen.textContent = 'Демонстрация экрана';
      ui.screenBadge.textContent = 'Экран: неактивен';
      ui.screenBadge.style.color = '';
      setStatus('', ui.stateText.textContent);
      
      // Update peer connection if exists
      if (S.pc) {
        const senders = S.pc.getSenders();
        senders.forEach(sender => {
          if (sender.track && sender.track.kind === 'video') {
            S.pc.removeTrack(sender);
          }
        });
        
        // Add microphone back if available
        if (S.mic) {
          S.mic.getTracks().forEach(track => {
            if (track.kind === 'audio') {
              S.pc.addTrack(track, S.mic);
            }
          });
        }
      }
    } else {
      // Start sharing
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });
        
        S.screen = stream;
        S.isSharingScreen = true;
        ui.btnScreen.textContent = 'Остановить демонстрацию';
        ui.screenBadge.textContent = 'Экран: активен';
        ui.screenBadge.style.color = '#d8b4fe';
        setStatus('screen', 'Демонстрация экрана');
        
        // Show preview
        ui.screenPreview.srcObject = stream;
        ui.screenPreview.style.display = 'block';
        ui.screenPreview.play().catch(() => { });
        
        // Handle when user stops sharing via browser UI
        stream.getVideoTracks()[0].onended = () => {
          toggleScreenShare();
        };
        
        // Update peer connection if exists
        if (S.pc) {
          // Remove existing video tracks
          const senders = S.pc.getSenders();
          senders.forEach(sender => {
            if (sender.track && sender.track.kind === 'video') {
              S.pc.removeTrack(sender);
            }
          });
          
          // Add screen tracks
          stream.getTracks().forEach(track => {
            S.pc.addTrack(track, stream);
          });
          
          // If we're the caller, renegotiate connection
          if (S.role === 'caller') {
            makeCode();
          }
        }
        
        return true;
      } catch (e) {
        console.error('Screen sharing error:', e);
        if (e.name !== 'NotAllowedError') {
          setStatus('bad', 'Ошибка демонстрации экрана');
        }
        return false;
      }
    }
  }
  
  // Show screen share button if supported
  if (navigator.mediaDevices && 'getDisplayMedia' in navigator.mediaDevices) {
    ui.btnScreen.style.display = 'inline-flex';
    ui.screenBadge.style.display = 'inline-flex';
    ui.btnScreen.onclick = toggleScreenShare;
  }

  // ----- RTCPeerConnection
  function iceServers() {
    return S.useStun ? [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' },
      { urls: 'stun:stun3.l.google.com:19302' }
    ] : [];
  }

  function newPC() {
    if (S.pc) { try { S.pc.close(); } catch { } }
    S.gathered = [];
    const pc = new RTCPeerConnection({ iceServers: iceServers() });
    S.pc = pc;

    // Add media tracks
    if (S.isSharingScreen) {
      S.screen.getTracks().forEach(track => pc.addTrack(track, S.screen));
    } else if (S.mic) {
      S.mic.getTracks().forEach(track => pc.addTrack(track, S.mic));
    }

    pc.ontrack = (ev) => {
      if (ev.track.kind === 'audio') {
        ui.remoteAudio.srcObject = ev.streams[0];
        ui.remoteAudio.play().catch(() => { });
        ui.btnMuteAudio.style.display = 'inline-flex';
        
        // Update mute button state
        ui.remoteAudio.onvolumechange = () => {
          S.isRemoteAudioMuted = ui.remoteAudio.muted;
          ui.btnMuteAudio.textContent = S.isRemoteAudioMuted ? 'Включить звук' : 'Выключить звук';
        };
      } else if (ev.track.kind === 'video') {
        ui.remoteScreen.srcObject = ev.streams[0];
        ui.remoteScreenContainer.style.display = 'block';
        ui.remoteScreen.play().catch(() => { });
      }
    };

    pc.onicecandidate = (ev) => { if (ev.candidate) S.gathered.push(ev.candidate.toJSON()); };

    pc.onconnectionstatechange = () => {
      const st = pc.connectionState;
      ui.callHint.textContent = 'Звонок: ' + st;

      if (st === 'connecting') { setStatus('warn', 'Соединяем…'); }
      if (st === 'connected') {
        setStatus(S.isSharingScreen ? 'screen' : 'ok', 'На связи');
        ui.btnHang.disabled = false;
      }
      if (st === 'failed') {
        setStatus('bad', 'Не удалось соединиться');
        ui.btnHang.disabled = true;
      }
      if (st === 'disconnected' || st === 'closed') {
        setStatus('warn', 'Связь прервана');
        ui.btnHang.disabled = true;
        ui.remoteScreenContainer.style.display = 'none';
        ui.remoteAudio.srcObject = null;
      }
    };
    return pc;
  }

  // ----- Fullscreen control
  function toggleFullscreen() {
    if (!ui.remoteScreen.srcObject) {
      console.log('Нет видео для отображения');
      return;
    }

    if (!document.fullscreenElement) {
      ui.remoteScreenContainer.requestFullscreen()
        .then(() => {
          ui.remoteScreenContainer.classList.add('fullscreen');
          ui.btnFullscreen.textContent = 'Свернуть';
          S.isFullscreen = true;
        })
        .catch(err => {
          console.error('Ошибка при переходе в полноэкранный режим:', err);
        });
    } else {
      document.exitFullscreen()
        .then(() => {
          ui.remoteScreenContainer.classList.remove('fullscreen');
          ui.btnFullscreen.textContent = 'Полный экран';
          S.isFullscreen = false;
        })
        .catch(err => {
          console.error('Ошибка при выходе из полноэкранного режима:', err);
        });
    }
  }

  ui.btnFullscreen.onclick = toggleFullscreen;

  // Mute/unmute remote audio
  ui.btnMuteAudio.onclick = () => {
    S.isRemoteAudioMuted = !S.isRemoteAudioMuted;
    ui.remoteAudio.muted = S.isRemoteAudioMuted;
    ui.btnMuteAudio.textContent = S.isRemoteAudioMuted ? 'Включить звук' : 'Выключить звук';
  };

  // Handle fullscreen change events
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      ui.remoteScreenContainer.classList.remove('fullscreen');
      ui.btnFullscreen.textContent = 'Полный экран';
      S.isFullscreen = false;
    }
  });

  // ----- base64 packers (для кодов)
  function pack(obj) {
    const s = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(s))).replaceAll('+', '-').replaceAll('/', '_').replace(/=+$/, '');
    return b64;
  }
  function unpack(b64url) {
    const b64 = b64url.replaceAll('-', '+').replaceAll('_', '/');
    const pad = b64.length % 4 === 0 ? '' : '='.repeat(4 - (b64.length % 4));
    const json = decodeURIComponent(escape(atob(b64 + pad)));
    return JSON.parse(json);
  }

  function waitIceComplete(pc, timeoutMs = 1200) {
    return new Promise((resolve) => {
      if (pc.iceGatheringState === 'complete') return resolve();
      const t = setTimeout(resolve, timeoutMs);
      pc.onicegatheringstatechange = () => {
        if (pc.iceGatheringState === 'complete') { clearTimeout(t); resolve(); }
      };
    });
  }

  // ----- Make/Accept codes
  async function makeCode() {
    if (!S.role) { alert('Выберите роль'); return; }
    if (S.role === 'caller' && !S.mic && !S.isSharingScreen) { 
      alert('Включите микрофон или демонстрацию экрана'); 
      return; 
    }
    const pc = newPC();
    if (S.role === 'caller') {
      const offer = await pc.createOffer({ 
        offerToReceiveAudio: true,
        offerToReceiveVideo: true
      });
      await pc.setLocalDescription(offer);
      await waitIceComplete(pc);
      const payload = { v: 2, role: 'caller', sdp: pc.localDescription.toJSON(), ice: S.gathered, t: Date.now() };
      ui.myCode.value = pack(payload);
      ui.btnCopy.disabled = false;
      ui.btnShare.disabled = !navigator.share;
      setStatus('warn', 'Ждём код ответа');
    } else {
      if (!ui.peerCode.value.trim()) { alert('Сначала вставьте код собеседника'); return; }
      const ok = await acceptCode(true); if (!ok) return;
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await waitIceComplete(pc);
      const payload = { v: 2, role: 'callee', sdp: pc.localDescription.toJSON(), ice: S.gathered, t: Date.now() };
      ui.myCode.value = pack(payload);
      ui.btnCopy.disabled = false;
      ui.btnShare.disabled = !navigator.share;
      setStatus('warn', 'Отправьте ваш код инициатору');
    }
  }
  ui.btnMake.onclick = makeCode;

  async function acceptCode(silent = false) {
    const code = ui.peerCode.value.trim();
    if (!code) { if (!silent) alert('Нет кода'); return false; }
    let obj;
    try { obj = unpack(code); }
    catch (e) { if (!silent) alert('Формат кода неверный'); return false; }
    if (!obj || !obj.sdp) { if (!silent) alert('В коде нет SDP'); return false; }
    const pc = S.pc ?? newPC();
    try { await pc.setRemoteDescription(obj.sdp); }
    catch (e) { if (!silent) alert('Не удалось применить описание'); return false; }
    if (Array.isArray(obj.ice)) { for (const c of obj.ice) { try { await pc.addIceCandidate(c); } catch { } } }
    if (!silent) setStatus('warn', 'Код принят. Сформируйте свой код.');
    return true;
  }
  ui.btnAccept.onclick = () => acceptCode(false);

  // ----- Clipboard + Share
  ui.btnCopy.onclick = async () => {
    try {
      await navigator.clipboard.writeText(ui.myCode.value); 
      ui.btnCopy.textContent = 'Скопировано ✓'; 
      setTimeout(() => ui.btnCopy.textContent = 'Копировать', 1200);
    } catch (e) { alert('Буфер обмена недоступен'); }
  };
  ui.btnShare.onclick = async () => {
    try { await navigator.share({ title: 'Код PeerCall', text: ui.myCode.value }); } catch { }
  };
  ui.btnPaste.onclick = async () => {
    try { const t = await navigator.clipboard.readText(); if (t) ui.peerCode.value = t; } catch { alert('Буфер обмена недоступен'); }
  };

  // ----- Hangup
  ui.btnHang.onclick = () => {
    try {
      if (S.pc) {
        S.pc.getSenders().forEach(s => { try { s.track && s.track.stop() } catch { } });
        S.pc.close();
      }
      S.pc = null;
      setStatus('warn', 'Звонок завершён');
      ui.btnHang.disabled = true; 
      ui.callHint.textContent = 'Звонок: нет';
      ui.remoteScreenContainer.style.display = 'none';
      ui.remoteAudio.srcObject = null;
    } catch { }
  };

  // ====== PWA установка ======
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    S.beforeInstallEvt = e;
    ui.btnInstall.hidden = false;
  });
  ui.btnInstall.onclick = async () => {
    if (!S.beforeInstallEvt) return;
    ui.btnInstall.disabled = true;
    await S.beforeInstallEvt.prompt();
    S.beforeInstallEvt = null;
    setTimeout(() => { ui.btnInstall.hidden = true; ui.btnInstall.disabled = false; }, 500);
  };

  // ====== Service Worker ======
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('SW registered'))
        .catch((e) => console.warn('SW failed', e));
    });
    // если SW обновился — перезагрузим страницу после простого диалога
    navigator.serviceWorker.addEventListener('message', (ev) => {
      if (ev.data && ev.data.type === 'NEW_VERSION') {
        const ok = confirm('Доступно обновление. Перезапустить приложение сейчас?');
        if (ok) location.reload();
      }
    });
  }

  // ----- Init
  setStatus('ok', 'Готово к началу');
})();
</script>
</body>
</html>